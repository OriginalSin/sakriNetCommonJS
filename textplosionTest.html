<!DOCTYPE html>
<html>
<head>
    <title>Textplosion Test</title>

    <script type="text/javascript" src="commonJS/MathUtil.js" ></script>
    <script type="text/javascript" src="commonJS/Geom.js" ></script>
    <script type="text/javascript" src="commonJS/RectangleUtil.js" ></script>
    <script type="text/javascript" src="commonJS/BitmapUtil.js" ></script>

    <script type="text/javascript">

    //==============::GA::====================================
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-393774-1']);
    _gaq.push(['_trackPageview']);

    (function() {
        var ga = document.createElement('script');
        ga.type = 'text/javascript';
        ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(ga, s);
    })();
    //==============::/GA::====================================

        var canvas;
        var context;
        var intervalId = -1;
        var bounds;
        var particles;
        var choppedTextImages;
        var maxSpeed = 12;
        var minSpeed = 6;
        var maxRotationSpeed = Math.PI/15;
        var textString = "SAKRI";
        var textStringParticles;
        var xOffset;
        var yOffset;
        var fontSize = 160;

        function init(){

            canvas = document.createElement('canvas');
            canvas.width = 800;
            canvas.height = 600;
            context = this.canvas.getContext("2d");
            this.canvasContainer = document.getElementById("canvasContainer");
            this.canvasContainer.appendChild(this.canvas);

            bounds = new Sakri.Geom.Rectangle(0,0, canvas.width, canvas.height);

            context.fillStyle = "#0b0b2e";
            context.font = "bold "+fontSize+"px sans-serif";
            context.textBaseline = "top";


            choppedTextImages = Sakri.BitmapUtil.createImagesFromString(textString, "#0b0b2e", fontSize, null, "bold");

            start();
        }

        function start(){
            context.clearRect(0, 0, canvas.width, canvas.height);
            xOffset = bounds.getCenterX() - context.measureText(textString).width/2;
            yOffset = bounds.getCenterY() - 60;
            context.fillText(textString, xOffset, yOffset);
            particles = Sakri.BitmapUtil.createTextParticles(textString, .2, fontSize, null, "bold" );//, "Arial"
            for(var i=0; i<particles.length;i++){
                particles[i].x+=xOffset;
                particles[i].y+=yOffset;
            }
            setTimeout(splode, 1000);
        }

        function setParticleTargets(){
            var i,particle;
            for(i=0; i<particles.length;i++){
                particle = particles[i];
                particle.xSpeed = Math.random()*maxSpeed *  (Math.random()>.5 ? -1 : 1);
                particle.ySpeed = Math.random()*maxSpeed *  (Math.random()>.5 ? -1 : 1);
                if(particle.xSpeed<minSpeed && particle.ySpeed<minSpeed){
                    if(Math.random()>.5){
                        particle.xSpeed = (minSpeed + Math.random()*maxSpeed) *  (Math.random()>.5 ? -1 : 1);
                    }else{
                        particle.ySpeed = (minSpeed + Math.random()*maxSpeed) *  (Math.random()>.5 ? -1 : 1);
                    }
                }
                particle.rotationSpeed = (Math.random()*maxRotationSpeed) *  (Math.random()>.5 ? -1 : 1);
                particle.rotation = 0;
                particle.characterIndex = Math.floor(Math.random()*choppedTextImages.length);
                particle.scaleSpeed = .002 + Math.random() * .01;
                particle.scale = .05;
            }
        }

        var startMove = 70;

        function splode(){
            setParticleTargets();
            textStringParticles = new Array();
            var imgX=0;
            var charimg;
            for(i=0; i<textString.length;i++){
                charimg = choppedTextImages[i];
                textStringParticles[i] = particles.splice(Math.floor(Math.random()*particles.length), 1)[0];
                textStringParticles[i].targetX = xOffset + imgX;
                textStringParticles[i].targetY = yOffset;
                textStringParticles[i].characterIndex = i;
                textStringParticles[i].scaleSpeed = .002;
                imgX += charimg.width;
            }
            intervalId = setInterval(updateParticles, 20);
            startMove = 30;
        }

        function updateParticles(){
            startMove--;
            context.clearRect(0, 0, canvas.width, canvas.height);
            var i,particle, charImg;
            for(i=particles.length-1; i>-1;i--){
                particle = particles[i];
                if(startMove<0){
                    particle.x += particle.xSpeed;
                    particle.y += particle.ySpeed;
                    particle.scale += particle.scale>=1 ? 0 : particle.scaleSpeed;
                }
                particle.rotation += particle.rotationSpeed;
                particle.rotation = Sakri.MathUtil.constrainRadianTo2PI(particle.rotation);
                if(!bounds.containsPoint(particle.x, particle.y)){
                    particles.splice(i,1);
                }else{
                    charImg = choppedTextImages[particle.characterIndex];
                    //context.fillRect(particle.x, particle.y, 3,3);
                    //context.drawImage(choppedTextImages[particle.characterIndex], particle.x, particle.y);
                    //context.translate(particle.x-charImg.width/2, particle.y-charImg.height/2);
                    context.translate(particle.x, particle.y);
                    context.rotate(particle.rotation);
                    context.drawImage(charImg, 0,0,charImg.width, charImg.height, -(charImg.width*particle.scale)/2, -(charImg.height*particle.scale)/2, charImg.width*particle.scale, charImg.height*particle.scale);
                    context.setTransform(1,0,0,1,0, 0);
                }
            }

            if(startMove<0){
                for(i=0; i<textStringParticles.length;i++){
                    particle = textStringParticles[i];
                    charImg = choppedTextImages[particle.characterIndex];
                    particle.x += (particle.targetX-particle.x)*.03;
                    particle.y += (particle.targetY-particle.y)*.03;
                    particle.scale += .005;
                    context.drawImage(charImg, 0, 0, charImg.width, charImg.height, particle.x, particle.y, charImg.width*particle.scale, charImg.height*particle.scale);
                }
            }

            if(!particles.length && particle.scale>.99){
                console.log("all done");
                clearInterval(intervalId);
                start();
            }
        }


        var readyStateCheckInterval = setInterval( function() {
            if (document.readyState === "complete") {
                clearInterval(readyStateCheckInterval);
                init();
            }
        }, 10);



    </script>

</head>
<body>
    <div id="canvasContainer"></div>
</body>
</html>